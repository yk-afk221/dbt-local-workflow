version: 2

sources:
  - name: raw
    description: |
      RAWデータ層。
      - dev/ciターゲット: dev_rawスキーマを参照
      - prd/prd_martsターゲット: prd_rawスキーマを参照

      BigQuery環境では:
      - dev_raw: テスト用データ（本番データのサブセット）
      - prd_raw: 本番データ

    # ターゲットに応じてスキーマを切り替え
    # dev, ci → dev_raw
    # prd, prd_marts → prd_raw
    schema: "{{ 'dev_raw' if target.name in ['dev', 'ci'] else 'prd_raw' }}"

    tables:
      - name: customers
        description: 顧客マスタデータ
        columns:
          - name: customer_id
            description: 顧客ID（主キー）
            data_tests:
              - unique
              - not_null
          - name: customer_name
            description: 顧客名
          - name: email
            description: メールアドレス
          - name: created_at
            description: 作成日時
          - name: updated_at
            description: 更新日時

      - name: orders
        description: 注文トランザクションデータ
        columns:
          - name: order_id
            description: 注文ID（主キー）
            data_tests:
              - unique
              - not_null
          - name: customer_id
            description: 顧客ID（外部キー）
            data_tests:
              - not_null
              - relationships:
                  to: source('raw', 'customers')
                  field: customer_id
          - name: order_date
            description: 注文日
          - name: amount
            description: 注文金額
          - name: status
            description: 注文ステータス
            data_tests:
              - accepted_values:
                  values: ['pending', 'completed', 'cancelled', 'shipped']
